<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlight Rater</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .progress { color: #888; margin-bottom: 20px; }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .clip-title {
            font-size: 1.2em;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        .clip-meta {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            margin-bottom: 15px;
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 8px;
        }
        .events-panel {
            max-height: 500px;
            overflow-y: auto;
        }
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .events-header h3 {
            margin: 0;
            color: #00ff88;
        }
        .event-count {
            color: #888;
            font-size: 0.9em;
        }
        .event-item {
            background: #0f3460;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: all 0.2s;
            opacity: 0.6;
        }
        .event-item.past {
            opacity: 0.4;
        }
        .event-item.current {
            opacity: 1;
            background: #1a4a5a;
            border-left: 3px solid #00d4ff;
        }
        .event-item.future {
            opacity: 0.7;
        }
        .event-item:hover {
            cursor: pointer;
            background: #1a4a5a;
        }
        .event-time {
            color: #00d4ff;
            font-family: monospace;
            font-size: 0.9em;
            min-width: 60px;
        }
        .event-type {
            font-weight: bold;
            min-width: 100px;
        }
        .event-type.kill { color: #ff6b6b; }
        .event-type.snail { color: #ffd93d; }
        .event-type.berry { color: #6bcb77; }
        .event-type.victory { color: #00ff88; }
        .event-type.maiden { color: #c56cf0; }
        .event-type.game { color: #888; }
        .event-details {
            color: #ccc;
            flex: 1;
        }
        .win-prob {
            color: #888;
            font-size: 0.85em;
        }
        .rating-panel {
            text-align: center;
            padding: 20px;
        }
        .rating-label {
            color: #888;
            margin-bottom: 15px;
        }
        .rating-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .rating-btn {
            padding: 12px 24px;
            border: 2px solid #555;
            border-radius: 8px;
            background: #0f3460;
            color: #eee;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        .rating-btn:hover {
            border-color: #00d4ff;
            background: #16213e;
        }
        .rating-btn.selected {
            border-color: #00ff88;
            background: #1a4a3a;
        }
        .rating-btn.great { border-color: #00ff88; }
        .rating-btn.good { border-color: #6bcb77; }
        .rating-btn.meh { border-color: #ffd93d; }
        .rating-btn.bad { border-color: #ff6b6b; }
        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .nav-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        .nav-btn.prev {
            background: #555;
            color: #eee;
        }
        .nav-btn.prev:hover { background: #666; }
        .nav-btn.next {
            background: #00d4ff;
            color: #000;
        }
        .nav-btn.next:hover { background: #00b8d9; }
        .nav-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .no-events {
            color: #888;
            text-align: center;
            padding: 30px;
        }
        .current-rating {
            margin-top: 10px;
            color: #00ff88;
        }
        .clip-link {
            color: #00d4ff;
            text-decoration: none;
        }
        .clip-link:hover {
            text-decoration: underline;
        }
        .teams-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px;
            background: #0f3460;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .team-name {
            font-size: 1.1em;
            font-weight: bold;
        }
        .team-name.blue { color: #4a9eff; }
        .team-name.gold { color: #ffd700; }
        .vs-text {
            color: #888;
            font-size: 0.9em;
        }
        .debug-panel {
            background: #0a0a15;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8em;
        }
        .debug-panel summary {
            cursor: pointer;
            color: #888;
        }
        .debug-panel .debug-content {
            margin-top: 10px;
            color: #aaa;
        }
        .debug-panel .debug-row {
            margin: 4px 0;
        }
        .debug-panel .warn {
            color: #ffd93d;
        }
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Highlight Rater</h1>
    <div class="progress" id="progress">Loading...</div>

    <div id="main-content">
        <div class="panel">
            <p style="color: #888;">Loading clips...</p>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script>
        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let ytApiReady = false;
        function onYouTubeIframeAPIReady() {
            ytApiReady = true;
            // If clips already loaded, re-render to use API
            if (currentClip) {
                renderClip();
            }
        }
    </script>
    <script>
        let clips = [];
        let currentIndex = 0;
        let currentClip = null;
        let player = null;
        let updateInterval = null;

        async function loadClips() {
            const resp = await fetch('/api/clips');
            clips = await resp.json();
            updateProgress();
            if (clips.length > 0) {
                loadClip(0);
            } else {
                document.getElementById('main-content').innerHTML = `
                    <div class="panel">
                        <p style="color: #ff6b6b;">No aligned clips found.</p>
                    </div>
                `;
            }
        }

        function updateProgress() {
            const rated = clips.filter(c => c.has_rating).length;
            document.getElementById('progress').textContent =
                `${rated} of ${clips.length} clips rated | Current: ${currentIndex + 1}/${clips.length}`;
        }

        async function loadClip(index, direction = 1) {
            // Skip already rated clips
            while (index >= 0 && index < clips.length && clips[index].has_rating) {
                index += direction;
            }

            if (index < 0 || index >= clips.length) {
                // All clips rated or no more in this direction
                if (clips.every(c => c.has_rating)) {
                    document.getElementById('main-content').innerHTML = `
                        <div class="panel">
                            <p style="color: #00ff88;">All clips have been rated!</p>
                        </div>
                    `;
                }
                return;
            }

            currentIndex = index;
            updateProgress();

            const clipInfo = clips[index];
            const resp = await fetch(`/api/clip/${clipInfo.clip_id}`);
            currentClip = await resp.json();
            renderClip();
        }

        function getEventTypeClass(eventType) {
            if (eventType === 'playerKill') return 'kill';
            if (eventType.includes('snail')) return 'snail';
            if (eventType.includes('berry')) return 'berry';
            if (eventType === 'victory') return 'victory';
            if (eventType.includes('Maiden') || eventType.includes('maiden')) return 'maiden';
            if (eventType === 'gamestart' || eventType === 'gameend') return 'game';
            return '';
        }

        function formatEventType(eventType) {
            const typeMap = {
                'playerKill': 'Kill',
                'snailEat': 'Snail Eat',
                'snailEscape': 'Snail Escape',
                'getOnSnail': 'On Snail',
                'getOffSnail': 'Off Snail',
                'berryDeposit': 'Berry',
                'berryKickIn': 'Berry Kick',
                'victory': 'Victory',
                'gamestart': 'Start',
                'gameend': 'End',
                'useMaiden': 'Maiden',
                'blessMaiden': 'Bless',
                'reserveMaiden': 'Reserve',
            };
            return typeMap[eventType] || eventType;
        }

        function renderClip() {
            const c = currentClip;
            const clipInfo = clips[currentIndex];

            // Build events HTML with data-time for scroll tracking
            let eventsHtml = '';
            if (c.events && c.events.length > 0) {
                eventsHtml = c.events.map((e, i) => `
                    <div class="event-item future" data-time="${e.relative_seconds}" data-index="${i}" onclick="seekToEvent(${e.relative_seconds})">
                        <span class="event-time">${e.time_str}</span>
                        <span class="event-type ${getEventTypeClass(e.event_type)}">${formatEventType(e.event_type)}</span>
                        <span class="event-details">${e.details}</span>
                        ${e.win_probability ? `<span class="win-prob">${(parseFloat(e.win_probability) * 100).toFixed(0)}%</span>` : ''}
                    </div>
                `).join('');
            } else {
                eventsHtml = '<div class="no-events">No events found in this clip</div>';
            }

            // Build debug info HTML
            const debug = c.debug || {};
            let debugHtml = '';
            if (debug.clip_utc_start) {
                const nearestBefore = debug.nearest_game_before;
                const nearestAfter = debug.nearest_game_after;
                let gapWarning = '';
                if (nearestBefore && nearestBefore.seconds_before > 300) {
                    gapWarning = `<div class="debug-row warn">Cache gap: nearest game is ${Math.round(nearestBefore.seconds_before)}s before clip</div>`;
                }
                debugHtml = `
                    <details class="debug-panel">
                        <summary>Debug Info</summary>
                        <div class="debug-content">
                            <div class="debug-row">Clip UTC: ${debug.clip_utc_start} to ${debug.clip_utc_end}</div>
                            <div class="debug-row">Games checked: ${debug.games_checked}</div>
                            ${nearestBefore ? `<div class="debug-row">Nearest before: game ${nearestBefore.game_id} (${Math.round(nearestBefore.seconds_before)}s before)</div>` : ''}
                            ${nearestAfter ? `<div class="debug-row">Nearest after: game ${nearestAfter.game_id} (${Math.round(nearestAfter.seconds_after)}s after)</div>` : ''}
                            ${gapWarning}
                        </div>
                    </details>
                `;
            }

            // Current rating display
            const currentRating = clipInfo.rating || c.rating;
            const ratingDisplay = currentRating ?
                `<div class="current-rating">Current rating: <strong>${currentRating}</strong></div>` : '';

            document.getElementById('main-content').innerHTML = `
                <div class="main-layout">
                    <div class="left-column">
                        <div class="panel">
                            <div class="clip-title">${c.title}</div>
                            <div class="clip-meta">
                                Duration: ${c.duration.toFixed(1)}s |
                                <a href="${c.clip_url}" target="_blank" class="clip-link">Open clip</a> |
                                <a href="${c.source_video_url}&t=${Math.floor(c.start_seconds)}" target="_blank" class="clip-link">Source video</a>
                            </div>
                            <div class="video-container">
                                <div id="player"></div>
                            </div>
                            <div class="teams-row">
                                <span class="team-name gold">${c.gold_team || 'Gold Team'}</span>
                                <span class="vs-text">vs</span>
                                <span class="team-name blue">${c.blue_team || 'Blue Team'}</span>
                            </div>
                            <div class="rating-panel">
                                <div class="rating-label">Rate this highlight:</div>
                                <div class="rating-buttons">
                                    <button class="rating-btn great ${currentRating === 4 ? 'selected' : ''}" onclick="rateClip(4)">4 - Great</button>
                                    <button class="rating-btn good ${currentRating === 3 ? 'selected' : ''}" onclick="rateClip(3)">3 - Good</button>
                                    <button class="rating-btn meh ${currentRating === 2 ? 'selected' : ''}" onclick="rateClip(2)">2 - Meh</button>
                                    <button class="rating-btn bad ${currentRating === 1 ? 'selected' : ''}" onclick="rateClip(1)">1 - Bad</button>
                                </div>
                                ${ratingDisplay}
                            </div>
                            <div class="nav-buttons">
                                <button class="nav-btn prev" onclick="loadClip(currentIndex - 1, -1)">Previous</button>
                                <button class="nav-btn next" onclick="loadClip(currentIndex + 1, 1)">Next</button>
                            </div>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="panel events-panel">
                            <div class="events-header">
                                <h3>Game Events</h3>
                                <span class="event-count">${c.event_count} events</span>
                            </div>
                            ${eventsHtml}
                            ${debugHtml}
                        </div>
                    </div>
                </div>
            `;

            // Clear previous interval
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }

            // Create YouTube player
            if (ytApiReady) {
                player = new YT.Player('player', {
                    videoId: c.source_video_id,
                    playerVars: {
                        'start': Math.floor(c.start_seconds),
                        'end': Math.ceil(c.end_seconds),
                        'autoplay': 1,
                        'enablejsapi': 1,
                        'origin': window.location.origin
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        function onPlayerReady(event) {
            // Start tracking playback position
            startEventTracking();
        }

        function onPlayerStateChange(event) {
            // YT.PlayerState.PLAYING = 1, YT.PlayerState.ENDED = 0
            if (event.data === 1) {
                startEventTracking();
            } else if (event.data === 0) {
                // Video ended - loop back to start of clip
                if (currentClip && player && player.seekTo) {
                    player.seekTo(currentClip.start_seconds, true);
                    player.playVideo();
                }
            } else {
                // Pause tracking when not playing
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }

        function startEventTracking() {
            if (updateInterval) return;
            updateInterval = setInterval(updateEventHighlight, 100);
        }

        function seekToEvent(relativeSeconds) {
            if (!player || !player.seekTo || !currentClip) return;
            const absoluteTime = currentClip.start_seconds + relativeSeconds;
            player.seekTo(absoluteTime, true);
        }

        function updateEventHighlight() {
            if (!player || !player.getCurrentTime || !currentClip) return;

            try {
                const currentTime = player.getCurrentTime();
                const clipStartTime = currentClip.start_seconds;
                const relativeTime = currentTime - clipStartTime;

                const eventsPanel = document.querySelector('.events-panel');
                const eventItems = document.querySelectorAll('.event-item');
                let currentEventEl = null;

                eventItems.forEach(el => {
                    const eventTime = parseFloat(el.dataset.time);
                    el.classList.remove('past', 'current', 'future');

                    if (eventTime < relativeTime - 0.5) {
                        el.classList.add('past');
                    } else if (eventTime <= relativeTime + 1.0) {
                        el.classList.add('current');
                        currentEventEl = el;
                    } else {
                        el.classList.add('future');
                    }
                });

                // Scroll to current event
                if (currentEventEl && eventsPanel) {
                    const panelRect = eventsPanel.getBoundingClientRect();
                    const elRect = currentEventEl.getBoundingClientRect();

                    // Check if element is outside visible area
                    if (elRect.top < panelRect.top || elRect.bottom > panelRect.bottom) {
                        currentEventEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            } catch (e) {
                // Player not ready
            }
        }

        async function rateClip(rating) {
            if (!currentClip) return;

            const resp = await fetch(`/api/clip/${currentClip.clip_id}/rate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating })
            });

            const result = await resp.json();
            if (result.success) {
                // Update local state
                clips[currentIndex].has_rating = true;
                clips[currentIndex].rating = rating;
                currentClip.rating = rating;
                updateProgress();
                // Auto-advance to next unrated clip
                loadClip(currentIndex + 1, 1);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'p') {
                loadClip(currentIndex - 1, -1);
            } else if (e.key === 'ArrowRight' || e.key === 'n') {
                loadClip(currentIndex + 1, 1);
            } else if (e.key === '4') {
                rateClip(4);
            } else if (e.key === '3') {
                rateClip(3);
            } else if (e.key === '2') {
                rateClip(2);
            } else if (e.key === '1') {
                rateClip(1);
            }
        });

        // Start
        loadClips();
    </script>
</body>
</html>
